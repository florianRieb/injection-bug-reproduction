package de.netzebw.service;

import static java.util.stream.Collectors.toSet;

import java.util.Collection;
import java.util.Objects;

import javax.enterprise.context.ApplicationScoped;

import de.netzebw.util.AbstractMessageService;
import de.netzebw.util.entity.StaticMessageTable;
import de.netzebw.util.to.Message;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import software.amazon.awssdk.services.dynamodb.DynamoDbClient;

@Slf4j
@RequiredArgsConstructor
@ApplicationScoped
public class MessageSyncService extends AbstractMessageService {

  private final DynamoDbClient dynamoDB;

  public static final String[] RELEVANT_DB_ATTRIBUTES =
      {StaticMessageTable.MSG_UUID_COL, StaticMessageTable.MSG_FUNCTIONAL_ID_COL, StaticMessageTable.MSG_CITY_COL,
          StaticMessageTable.MSG_REPORTING_TIMESTAMP_COL,
      };

  public Collection<Message> findAll() {

    log.info("Try to scan all entries of table {} ", StaticMessageTable.MESSAGE_TABLE_NAME);
    return dynamoDB.scanPaginator(scanRequest()).items().stream()
        .map(Message::fromMapToItem).filter(Objects::nonNull)
        .collect(toSet());

  }

}
